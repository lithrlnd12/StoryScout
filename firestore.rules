rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /publicContent/{document=**} {
      allow read: if true;
      allow write: if request.auth != null; // Authenticated users can write
    }

    match /users/{userId}/{document=**} {
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
    }

    // Engagements: users can create/read their own, read others
    match /engagements/{engagementId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Reviews: users can create/update/delete their own, read all
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Watch Parties: authenticated users can create, anyone can read, host/participants can update
    match /watchParties/{partyId} {
      allow read: if true; // Anyone can read parties (for joining)
      allow create: if request.auth != null; // Authenticated users can create parties

      // Only host or current participants can update
      allow update: if request.auth != null && (
        resource.data.hostUserId == request.auth.uid ||
        request.auth.uid in resource.data.participants.map(p, p.userId)
      );

      // Only host can delete
      allow delete: if request.auth != null && resource.data.hostUserId == request.auth.uid;
    }

    // Watch Party Chat: authenticated users can create, anyone can read
    match /watchParties/{partyId}/chat/{messageId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false; // Messages are immutable
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
